<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title>Airport Emissions & Flight Network Visualization</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    /* Base Styles */
    body { margin:0; padding:0; font-family: sans-serif; }
    #map-container { position: relative; width: 100%; height: 100vh; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    
    /* UI Panel Base Styles */
    .ui-panel {
      position: absolute;
      background: rgba(17, 17, 17, 0.9);
      color: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      z-index: 10;
      transition: all 0.3s ease;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* Panel States */
    .hidden {
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
    }
    .visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }
    
    /* Control Panel - Top Left */
    .control-panel {
      top: 80px;
      left: 20px;
      width: 250px;
    }
    .control-panel h3 {
      margin: 0 0 15px;
      font-size: 16px;
      color: #fff;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      padding-bottom: 8px;
    }
    .control-panel label {
      display: block;
      margin-bottom: 10px;
      line-height: 1.5;
    }
    .control-panel input[type=range] {
      width: 100%;
      margin: 8px 0;
    }
    
    /* Chart Container - Bottom Left (Centered) */
    .chart-container {
      bottom: 20px;
      left: 20px;
      width: 600px;
      height: 360px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 15px;
      box-sizing: border-box;
    }
    .chart-container h4 {
      margin: 0 0 12px;
      font-size: 14px;
      text-align: center;
      width: 100%;
    }
    .chart-selector {
      margin: 0 auto 12px;
      background: #333;
      color: #fff;
      border: 1px solid #444;
      padding: 6px 10px;
      width: 90%;
      border-radius: 4px;
      font-size: 13px;
      display: block;
    }
    
    /* Chart Styles (Centered) */
    #bar-chart-europe, #bar-chart-gva {
      width: 550px;
      height: 300px;
      margin-top: 10px;
      display: flex;
      justify-content: center;
    }
    .axis-label, .tick text { 
      font-size: 11px; 
      fill: #eee; 
    }
    
    /* Legend Panel - Bottom Right */
    .legend-container {
      bottom: 20px;
      right: 20px;
      width: 180px;
    }
    .legend-title {
      margin: 0 0 10px;
      font-size: 14px;
      font-weight: bold;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      padding-bottom: 6px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin: 10px 0;
      font-size: 13px;
    }
    
    /* Europe Legend Color Gradient */
    .gradient-bar {
      width: 100%;
      height: 12px;
      background: linear-gradient(to right, #8dd3c7, #ffffb3, #fb8072);
      margin: 10px 0;
      border-radius: 3px;
    }
    .legend-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-top: -5px;
    }
    
    /* Geneva Legend Line Samples */
    .line-sample {
      width: 35px;
      height: 3px;
      margin-right: 12px;
      border-radius: 2px;
    }
    .line-sample.civil { background: #66c2a5; }
    .line-sample.private { background: #fc8d62; }
    .line-sample.private-500 { background: #ffff00; }
    
    /* View Toggle Button */
    .toggle-view {
      position: absolute;
      top: 80px;
      right: 20px;
      z-index: 100;
      background: rgba(40, 40, 40, 0.95);
      color: #fff;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      border: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      transition: all 0.2s ease;
    }
    .toggle-view:hover {
      background: rgba(60, 60, 60, 0.95);
      transform: translateY(-1px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.4);
    }
    
    /* Button Styles */
    .btn {
      background: #444;
      color: #fff;
      border: none;
      padding: 8px 12px;
      margin-top: 12px;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s ease;
      font-size: 13px;
    }
    .btn:hover {
      background: #555;
    }
    
    /* Responsive Design */
    @media (max-width: 900px) {
      .chart-container {
        width: calc(100% - 40px);
        height: 360px;
      }
      #bar-chart-europe, #bar-chart-gva {
        width: calc(100% - 30px);
      }
      .legend-container {
        width: 160px;
      }
      .control-panel {
        width: 220px;
      }
    }

    /* Navigation Bar */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background-color: #1e2a35;
      z-index: 1000;
      margin: 0;
      padding: 0;
      list-style: none;
      display: flex;
      align-items: center;
    }
    .navbar li {
      margin: 0 15px;
    }
    .navbar a {
      color: white;
      text-decoration: none;
      font-size: 14px;
    }
    .navbar .logo {
      margin-right: auto;
      display: flex;
      align-items: center;
    }
    .logo-image {
      height: 30px;
      margin-right: 10px;
    }
    .logo-text {
      font-weight: bold;
      font-size: 16px;
    }

    /* Key Findings Panel */
    .conclusion-panel {
      position: absolute;
      bottom: 180px;
      right: 20px;
      width: 180px;
      background: rgba(30, 42, 53, 0.95);
      color: white;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.4;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }
    .conclusion-panel h4 {
      margin: 0 0 8px;
      font-size: 14px;
      color: #a1c4fd;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .conclusion-item {
      display: flex;
      align-items: center;
      margin: 8px 0;
      padding: 6px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.05);
    }
    .conclusion-item:last-child {
      border-bottom: none;
    }
    .conclusion-icon {
      font-size: 16px;
      margin-right: 8px;
      opacity: 0.8;
    }
    .conclusion-text {
      flex: 1;
      font-size: 13px;
      font-weight: 400;
      line-height: 1.5;
      color: rgba(255, 255, 255, 0.9);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      padding-left: 2px;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <ul class="navbar">
    <li class="logo">
      <a href="#Home">
        <img src="images/logo.svg" alt="Logo" class="logo-image">
        <span class="logo-text">AVIATION NETWORK</span>
      </a>
    </li>
    <li><a href="index.html">Home</a></li>
    <li><a href="Tab1_3DGlobe.html">Global</a></li>
    <li><a href="Tab2_Europe.html">Continent</a></li>
    <li><a href="Tab3_City.html">City</a></li>
    <li><a href="Authors.html">Authors</a></li>
    <li><a href="Reference.html">Reference</a></li>
  </ul>

  <!-- Main Map Container -->
  <div id="map-container">
    <div id="map"></div>

    <!-- Europe Control Panel -->
    <div id="controls-europe" class="ui-panel control-panel visible">
      <h3>CO₂ Emissions Visualization</h3>
      <label>
        Year: <span id="yearLabel">2019</span>
        <input type="range" id="yearSlider" min="2019" max="2024" value="2019">
      </label>
      <label><input type="radio" name="sizeby" value="co2" checked> Size by Emissions</label>
      <label><input type="radio" name="sizeby" value="FLT_TOT_1"> Size by Flight Count</label>
      <button class="btn" onclick="toggleChart('europe')">Toggle Chart</button>
    </div>

    <!-- Geneva Control Panel -->
    <div id="controls-gva" class="ui-panel control-panel hidden">
      <h3>Geneva Airport Flights</h3>
      <label><input type="checkbox" id="toggleCivil" checked> Show Commercial Flights</label>
      <label><input type="checkbox" id="togglePrivate"> Show Private Flights</label>
      <button class="btn" onclick="toggleChart('gva')">Toggle Chart</button>
    </div>

    <!-- Europe Chart (Centered) -->
    <div id="chart-europe" class="chart-container ui-panel visible">
      <select id="chart-selector-europe" class="chart-selector">
        <option value="comm">Top 10 Commercial Emissions</option>
        <option value="priv">Top 10 Private Jet Emissions</option>
      </select>
      <div id="bar-chart-europe"></div>
    </div>
      
    <!-- Geneva Chart (Centered) -->
    <div id="chart-gva" class="chart-container ui-panel hidden">
      <select id="chart-selector-gva" class="chart-selector">
        <option value="flight_count">Top 10 by Flight Count</option>
        <option value="total_emissions_kt">Top 10 by Emissions</option>
      </select>
      <div id="bar-chart-gva"></div>
    </div>

    <!-- Europe Legend -->
    <div id="legend-europe" class="legend-container ui-panel visible">
      <div class="legend-title">Emissions Legend</div>
      <div class="gradient-bar"></div>
      <div class="legend-labels">
        <span>Low</span>
        <span>High</span>
      </div>
    </div>

    <!-- Key Findings Panel -->
    <div id="conclusion-europe" class="conclusion-panel">
      <h4>Key Findings</h4>
      <div class="conclusion-item">
        <div class="conclusion-icon">·</div>
        <div class="conclusion-text">Top 3 airports contribute 42% of total emissions</div>
      </div>
      <div class="conclusion-item">
        <div class="conclusion-icon">·</div>
        <div class="conclusion-text">Private jet emissions growing at 23% rate</div>
      </div>
      <div class="conclusion-item">
        <div class="conclusion-icon">·</div>
        <div class="conclusion-text">Carbon emissions show core-periphery pattern</div>
      </div>
    </div>
      
    <!-- Geneva Legend -->
    <div id="legend-gva" class="legend-container ui-panel hidden">
      <div class="legend-title">Flight Types</div>
      <div class="legend-item"><div class="line-sample civil"></div><span>Commercial</span></div>
      <div class="legend-item"><div class="line-sample private"></div><span>Private Jet</span></div>
      <div class="legend-item"><div class="line-sample private-500"></div><span>Frequent Private</span></div>
    </div>

    <!-- View Toggle Button -->
    <button class="toggle-view" id="toggleView">Show Geneva Airport View</button>
  </div>

  <script>
    // Initialize Mapbox with access token
    mapboxgl.accessToken = 'pk.eyJ1IjoiaWVtb24iLCJhIjoiY201eTJ5OHQ5MDI2azJzc2Myd2tqcjdkdyJ9.HnSzYpnN2ZdrauoEIHL-Pg';
    
    // Create map instance centered on Europe
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/dark-v11',
      center: [10, 50], // Europe center coordinates
      zoom: 4 // Initial zoom level
    });

    // Global variables
    let currentYear = 2019;
    let currentSizeField = 'co2';
    let isGVAMode = false;
    let isTransitioning = false;
    let gvaRoutesLoaded = false;
    let currentPopup = null; // Currently displayed popup
    let hoverTimeout = null; // Timeout for hover effects

    /**
     * Load Geneva flight routes data from Mapbox sources
     */
    function loadGVARoutes() {
      if (gvaRoutesLoaded) return;
      
      // Add civil flight routes source and layer
      map.addSource('civil_routes', { 
        type: 'vector', 
        url: 'mapbox://iemon.bv34j20f' 
      });
      
      map.addLayer({
        id: 'civil-lines',
        type: 'line',
        source: 'civil_routes',
        'source-layer': 'gva_flight_routes-dbz7jr',
        layout: { visibility: 'none' },
        paint: {
          'line-color': '#66c2a5',
          'line-width': ['interpolate', ['linear'], ['get', 'flight_count'], 1, 0.5, 100, 5],
          'line-opacity': 0.7
        }
      });
      
      // Add private flight routes source and layer
      map.addSource('private_routes', { 
        type: 'vector', 
        url: 'mapbox://iemon.cb9eylv1' 
      });
      
      map.addLayer({
        id: 'private-lines',
        type: 'line',
        source: 'private_routes',
        'source-layer': 'gva_filtered_routes-6ti85l',
        layout: { visibility: 'none' },
        filter: ['<', ['get', 'flight_count'], 500],
        paint: {
          'line-color': '#fc8d62',
          'line-width': ['interpolate', ['linear'], ['get', 'flight_count'], 1, 0.5, 100, 6],
          'line-opacity': 0.7
        }
      });
      
      // Add frequent private routes layer (500+ flights)
      map.addLayer({
        id: 'private-lines-500plus',
        type: 'line',
        source: 'private_routes',
        'source-layer': 'gva_filtered_routes-6ti85l',
        layout: { visibility: 'none' },
        filter: ['>=', ['get', 'flight_count'], 500],
        paint: {
          'line-color': '#ffff00',
          'line-width': 6,
          'line-opacity': 0.9
        }
      });

      gvaRoutesLoaded = true;
    }

    /**
     * Initialize map after loading
     */
    map.on('load', () => {
      // Add Europe airports data source
      map.addSource('airports', {
        type: 'vector',
        url: 'mapbox://iemon.25d7i68u'
      });

      // Create airports visualization layer
      map.addLayer({
        id: 'circles',
        type: 'circle',
        source: 'airports',
        'source-layer': 'europe_airports_co2_verified-blzjja',
        paint: {
          'circle-radius': [
            'case',
            ['==', currentSizeField, 'FLT_TOT_1'],
            ['interpolate', ['linear'], ['get', 'FLT_TOT_1'], 0, 6, 1000000, 60],
            ['interpolate', ['linear'], ['get', 'co2'], 0, 8, 1000, 28]
          ],
          'circle-color': [
            'interpolate', ['linear'], ['get', 'co2'],
            0, '#8dd3c7',
            500, '#ffffb3',
            1000, '#fb8072'
          ],
          'circle-stroke-color': '#ffffff',
          'circle-stroke-width': 1.2,
          'circle-opacity': 0.25
        },
        filter: ['==', ['get', 'YEAR'], currentYear]
      });

      // Preload Geneva data
      loadGVARoutes();
      setupEventListeners();
      drawEuropeChart(currentYear);
      
      // Add hover effects to conclusion panel
      const conclusionPanel = document.getElementById('conclusion-europe');
      conclusionPanel.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-5px)';
        this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.4)';
      });
      conclusionPanel.addEventListener('mouseleave', function() {
        this.style.transform = '';
        this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
      });
    });

    /**
     * Set up all event listeners
     */
    function setupEventListeners() {
      // Airport hover interaction
      map.on('mouseenter', 'circles', (e) => {
        if (hoverTimeout) clearTimeout(hoverTimeout);
        
        hoverTimeout = setTimeout(() => {
          const props = e.features[0].properties;
          if (currentPopup) currentPopup.remove();
          
          currentPopup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false,
            offset: [0, -15]
          })
            .setLngLat(e.lngLat)
            .setHTML(`
              <strong>${props.APT_NAME}</strong><br>
              Country: ${props.STATE_NAME}<br>
              Year: ${props.YEAR}<br>
              CO₂: ${props.co2} kt<br>
              Flights: ${props.FLT_TOT_1}
            `)
            .addTo(map);
        }, 300);
      });

      map.on('mouseleave', 'circles', () => {
        if (hoverTimeout) clearTimeout(hoverTimeout);
        if (currentPopup) currentPopup.remove();
        currentPopup = null;
      });

      // Flight route hover interaction
      map.on('mouseenter', ['civil-lines', 'private-lines', 'private-lines-500plus'], (e) => {
        if (hoverTimeout) clearTimeout(hoverTimeout);
        
        hoverTimeout = setTimeout(() => {
          const p = e.features[0].properties;
          if (currentPopup) currentPopup.remove();
          
          currentPopup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false,
            offset: [0, -15]
          })
            .setLngLat(e.lngLat)
            .setHTML(`
              <strong>${p.origin || 'Geneva'} → ${p.destination}</strong><br>
              Flights: ${p.flight_count}
            `)
            .addTo(map);
        }, 300);
      });

      map.on('mouseleave', ['civil-lines', 'private-lines', 'private-lines-500plus'], () => {
        if (hoverTimeout) clearTimeout(hoverTimeout);
        if (currentPopup) currentPopup.remove();
        currentPopup = null;
      });
      
      // Year slider control
      document.getElementById('yearSlider').addEventListener('input', (e) => {
        const year = +e.target.value;
        currentYear = year;
        document.getElementById('yearLabel').textContent = year;
        drawEuropeChart(year);
        map.setFilter('circles', ['==', ['get', 'YEAR'], year]);
      });

      // Size by radio buttons
      document.querySelectorAll('input[name="sizeby"]').forEach(radio => {
        radio.addEventListener('change', function(e) {
          currentSizeField = e.target.value;
          map.setPaintProperty('circles', 'circle-radius',
            currentSizeField === 'FLT_TOT_1'
            ? ['interpolate', ['linear'], ['get', 'FLT_TOT_1'], 0, 6, 1000000, 60]
            : ['interpolate', ['linear'], ['get', 'co2'], 0, 8, 1000, 28]
          );
        });
      });

      // Chart type selectors
      document.getElementById("chart-selector-europe").addEventListener("change", function() {
        drawEuropeChart(currentYear);
      });

      document.getElementById("chart-selector-gva").addEventListener("change", function() {
        drawGVAChart(this.value);
      });

      // Flight visibility toggles
      document.getElementById('toggleCivil').addEventListener('change', e => {
        if (isGVAMode) {
          map.setLayoutProperty('civil-lines', 'visibility', e.target.checked ? 'visible' : 'none');
        }
      });
      
      document.getElementById('togglePrivate').addEventListener('change', e => {
        if (isGVAMode) {
          const vis = e.target.checked ? 'visible' : 'none';
          map.setLayoutProperty('private-lines', 'visibility', vis);
          map.setLayoutProperty('private-lines-500plus', 'visibility', vis);
        }
      });
    }

    /**
     * Draw Europe bar chart with centered layout
     * @param {number} year - The year to display data for
     */
    function drawEuropeChart(year) {
      const selected = document.getElementById('chart-selector-europe').value;
      const url = selected === 'comm'
        ? 'https://raw.githubusercontent.com/SkyGarry/03vis/main/finalmatched_europe.csv'
        : 'https://raw.githubusercontent.com/SkyGarry/03vis/main/private_jet_stats_matched_by_year_airport.csv';

      d3.csv(url).then(data => {
        // Filter and sort data
        const filtered = data.filter(d => +d.YEAR === year);
        const key = selected === 'comm' ? 'co2(kt)' : 'private_co2_emission(kt)';
        const sorted = filtered.sort((a, b) => +b[key] - +a[key]).slice(0, 10);

        // Clear previous chart and create SVG
        d3.select("#bar-chart-europe").selectAll("svg").remove();
        const svg = d3.select("#bar-chart-europe").append("svg")
              .attr("width", 550)
              .attr("height", 300);

        // Set up chart dimensions and margins
        const margin = {top: 20, right: 30, bottom: 60, left: 150},
              width = 550 - margin.left - margin.right,
              height = 300 - margin.top - margin.bottom;

        const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

        // Create scales
        const y = d3.scaleBand()
          .domain(sorted.map(d => d.APT_NAME))
          .range([0, height])
          .padding(0.2);

        const x = d3.scaleLinear()
          .domain([0, d3.max(sorted, d => +d[key])])
          .range([0, width]);

        // Add axes
        g.append("g")
          .call(d3.axisLeft(y))
          .selectAll("text")
          .style("text-anchor", "end")
          .attr("dx", "-0.4em");

        g.append("g")
          .attr("transform", `translate(0,${height})`)
          .call(d3.axisBottom(x))
          .append("text")
          .attr("x", width)
          .attr("y", -6)
          .attr("fill", "#fff")
          .attr("text-anchor", "end")
          .text("kt CO₂");

        // Create bars
        g.selectAll("rect")
          .data(sorted)
          .enter()
          .append("rect")
          .attr("x", 0)
          .attr("y", d => y(d.APT_NAME))
          .attr("width", d => x(+d[key]))
          .attr("height", y.bandwidth())
          .attr("fill", selected === 'comm' ? '#80b1d3' : '#fb8072');
      });
    }

    /**
     * Draw Geneva bar chart with centered layout
     * @param {string} metric - The metric to display ('flight_count' or 'total_emissions_kt')
     */
    function drawGVAChart(metric) {
      d3.csv('https://raw.githubusercontent.com/SkyGarry/03vis/main/Standardized_GVA_Destinations.csv').then(data => {
        // Process data
        const top = data.map(d => ({
          destination_city: d.destination_city,
          value: metric === 'total_emissions_kt' ? (+d[metric] / 1000) : +d[metric]
        })).sort((a, b) => b.value - a.value).slice(0, 10);

        const xLabel = metric === 'total_emissions_kt' ? 'CO₂ Emissions (kt)' : 'Flight Count';

        // Clear previous chart and create SVG
        d3.select('#bar-chart-gva').selectAll('*').remove();
        const svg = d3.select('#bar-chart-gva').append('svg')
              .attr('width', 550)
              .attr('height', 300);

        // Set up chart dimensions and margins
        const margin = {top: 20, right: 30, bottom: 60, left: 150},
              width = 550 - margin.left - margin.right,
              height = 300 - margin.top - margin.bottom,
              g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

        // Create scales
        const x = d3.scaleLinear().domain([0, d3.max(top, d => d.value)]).range([0, width]);
        const y = d3.scaleBand().domain(top.map(d => d.destination_city)).range([0, height]).padding(0.2);

        // Add axes
        g.append('g').call(d3.axisLeft(y));
        g.append('g')
          .attr('transform', `translate(0,${height})`)
          .call(d3.axisBottom(x))
          .append('text')
          .attr('x', width)
          .attr('y', 30)
          .attr('fill', '#fff')
          .attr('text-anchor', 'end')
          .text(xLabel);  

        // Create bars
        g.selectAll('rect')
          .data(top)
          .enter()
          .append('rect')
          .attr('y', d => y(d.destination_city))
          .attr('width', d => x(d.value))
          .attr('height', y.bandwidth())
          .attr('fill', metric === 'total_emissions_kt' ? '#fb8072' : '#80b1d3');
      });
    }

    /**
     * Toggle between Europe and Geneva views
     */
    document.getElementById('toggleView').addEventListener('click', function() {
      if (isTransitioning) return;
      isTransitioning = true;
      
      const btn = this;
      
      if (!isGVAMode) {
        // Switch to Geneva view
        btn.textContent = 'Show Europe View';
        
        // Hide Europe UI elements
        document.querySelectorAll('#controls-europe, #chart-europe, #legend-europe, #conclusion-europe').forEach(el => {
          el.classList.remove('visible');
          el.classList.add('hidden');
        });
        
        // Fly to Geneva
        map.flyTo({
          center: [6.109, 46.238], // Geneva coordinates
          zoom: 4.5,
          speed: 1.8,
          curve: 1.2,
          essential: true
        });
        
        setTimeout(() => {
          // Hide Europe layer
          map.setLayoutProperty('circles', 'visibility', 'none');
          
          // Show Geneva layers based on checkbox states
          const showCivil = document.getElementById('toggleCivil').checked;
          const showPrivate = document.getElementById('togglePrivate').checked;
          
          map.setLayoutProperty('civil-lines', 'visibility', showCivil ? 'visible' : 'none');
          map.setLayoutProperty('private-lines', 'visibility', showPrivate ? 'visible' : 'none');
          map.setLayoutProperty('private-lines-500plus', 'visibility', showPrivate ? 'visible' : 'none');
          
          // Show Geneva UI elements
          document.querySelectorAll('#controls-gva, #chart-gva, #legend-gva').forEach(el => {
            el.classList.remove('hidden');
            el.classList.add('visible');
          });
          
          // Draw Geneva chart
          drawGVAChart(document.getElementById('chart-selector-gva').value);
          
          isGVAMode = true;
          isTransitioning = false;
        }, 300);
        
      } else {
        // Switch back to Europe view
        btn.textContent = 'Show Geneva Airport View';
        
        // Hide Geneva UI elements
        document.querySelectorAll('#controls-gva, #chart-gva, #legend-gva').forEach(el => {
          el.classList.remove('visible');
          el.classList.add('hidden');
        });
        
        // Hide Geneva layers
        map.setLayoutProperty('civil-lines', 'visibility', 'none');
        map.setLayoutProperty('private-lines', 'visibility', 'none');
        map.setLayoutProperty('private-lines-500plus', 'visibility', 'none');
        
        // Fly back to Europe
        map.flyTo({
          center: [10, 50], // Europe center coordinates
          zoom: 4,
          speed: 1.8,
          curve: 1.2,
          essential: true
        });
        
        setTimeout(() => {
          // Show Europe layer
          map.setLayoutProperty('circles', 'visibility', 'visible');
          
          // Show Europe UI elements
          document.querySelectorAll('#controls-europe, #chart-europe, #legend-europe, #conclusion-europe').forEach(el => {
            el.classList.remove('hidden');
            el.classList.add('visible');
          });
          
          isGVAMode = false;
          isTransitioning = false;
        }, 300);
      }
    });

    /**
     * Toggle chart visibility
     * @param {string} view - The view to toggle ('europe' or 'gva')
     */
    function toggleChart(view) {
      const chart = document.getElementById(`chart-${view}`);
      chart.style.display = chart.style.display === 'none' ? 'block' : 'none';
    }
  </script>
</body>
</html>