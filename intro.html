<!DOCTYPE html>
<html lang="en">

<head>
    <title>Global Carbon Footprint and GDP Relationship</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- 使用CDN加载D3和相关库 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-tip@0.9.1/dist/index.js"></script>
    <script src="https://unpkg.com/flubber@0.4.2/build/flubber.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    
    <!-- 基础样式库 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        .chart {
            width: 100%;
            height: 90vh;
            display: grid;
            grid-template-rows: 10% 80%;
            background-color: #f4f4f4;
            position: sticky;
            top: 0;
        }

        #map {
            width: 100%;
            height: 80vh;
            position: relative;
            overflow: visible;
        }

        body {
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            background-color: #1A2A43;
            color: #fff;
        }
        
        .title {
            font-size: 45px;
            text-align: center;
            font-weight: bold;
            color: rgb(0, 0, 0);
        }
        
        .maptitle {
            font-size: 30px;
            text-align: center;
            font-weight: bold;
            color: rgb(0, 0, 0);
            margin-top: 2%;
        }

        text {
            fill: gray;
            font-size: 12px;
        }

        g line {
            stroke: lightgray;
        }
        
        /* 坐标轴样式增强 */
        .x-axis text, .y-axis text {
            font-size: 12px;
            fill: #333;
        }
        
        .x-axis path, .y-axis path,
        .x-axis line, .y-axis line {
            stroke: #333;
        }
        
        /* 网格线样式 - 确保在数据点下方 */
        .grid-line {
            stroke: #eee;
            shape-rendering: crispEdges;
        }
        
        /* 确保数据点在网格线上方 */
        .datapoint, .country, circle {
            z-index: 10;
            position: relative;
        }
        
        .x-label, .y-label {
            font-size: 14px !important;
            font-weight: bold !important;
            fill: #333 !important;
        }

        #chartArea {
            display: grid;
            grid-template-columns: 70% 25%;
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
            background-color: #f4f4f4;
            color: #333;
        }
        
        #container1 {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        .country {
            stroke: white;
            stroke-width: 0.5px;
            cursor: pointer;
        }

        .country:hover {
            stroke-width: 2px;
            stroke: black;
        }

        /* 自定义的tooltip样式，覆盖默认的 */
        .custom-tooltip {
            position: absolute;
            padding: 10px;
            background-color: white;
            border: 1px solid #666;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
            z-index: 1000;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            font-size: 14px;
            max-width: 200px;
            color: #333;
            font-weight: normal;
            line-height: 1.4;
        }
        
        .custom-tooltip h4 {
            margin: 0 0 8px 0;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            font-size: 16px;
            color: #4682B4;
        }
        
        .custom-tooltip p {
            margin: 4px 0;
        }
        
        .custom-tooltip .data-value {
            font-weight: bold;
        }

        .europe {
            fill: #4682B4;
        }

        circle.europe {
            stroke: #4682B4;
            stroke-width: 1px;
        }
        
        /* 步骤指示器 */
        .step-indicator {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .step {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ccc;
            cursor: pointer;
        }

        .step.active {
            background-color: #314563;
        }
        
        /* 标题样式 */
        .europe-label, .europe-scatter-label {
            font-size: 18px !important;
            font-weight: bold !important;
            fill: #333 !important;
            text-anchor: middle !important;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 5px;
        }
        
        /* 地图标题容器 */
        .title-container {
            position: absolute;
            top: 10px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 100;
            pointer-events: none;
        }
        
        /* 标题背景 */
        .title-background {
            background-color: rgba(255, 255, 255, 0.7);
            padding: 8px 15px;
            border-radius: 5px;
            display: inline-block;
        }

        /* 介绍部分的样式，改为更紧凑的布局 */
        .intro-section {
            padding: 40px 0;
            background-color: #1A2A43;
            color: #fff;
        }

        .intro-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            flex-wrap: wrap;
        }

        .intro-title {
            width: 100%;
            margin-bottom: 30px;
        }

        .intro-title h1 {
            font-size: 3rem;
            text-align: left;
            font-weight: bold;
            margin: 0;
        }

        .intro-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }

        .intro-text {
            flex: 1;
            min-width: 300px;
        }

        .intro-image {
            flex: 1;
            min-width: 300px;
            max-width: 500px;
            overflow: hidden;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .intro-image img {
            width: 100%;
            height: auto;
            display: block;
            object-fit: cover;
        }

        .intro-text h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .intro-text ul {
            list-style-type: disc;
            padding-left: 20px;
            margin-bottom: 25px;
        }

        .intro-text li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        /* 右侧说明文本样式 */
        .right-side-div {
            height: auto;
            margin-left: 10px;
            margin-bottom: 20px;
        }
        
        .right-side-header {
            background-color: #314563;
            margin-bottom: 10px;
            color: #fff;
            font-size: 15px;
            padding: 5px;
        }
        
        .right-text {
            background-color: #f1f1f1;
            border-left: 2px solid gray;
            padding: 10px;
            line-height: 1.5;
            color: #333;
        }

        /* 响应式调整 */
        @media (max-width: 992px) {
            .intro-content {
                flex-direction: column;
            }
            
            .intro-image {
                max-width: 100%;
                margin-bottom: 20px;
            }
            
            #chartArea {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
            }
        }
    </style>
</head>

<body>

    
    <!-- 从GlobalCarbonGDP.html整合的可视化部分 -->
    <article>
        <div id="container1">
            <section id="chartArea">
                <section class="chart">
                    <div class="maptitle">
                        <h2>2019 Carbon Footprint Around the World</h2>
                    </div>
                    <div id="map">
                        <!-- D3 visualization will be inserted here -->
                          </div>
                </section>
                <section>
                    <div class="right-side-div">
                        <div class="right-side-header">
                            <span style="margin-left:5px;">
                                Introduction to Carbon Footprint Map
                            </span>
                      </div>
                        <p class="right-text">
                            This map shows carbon footprint levels around the world. Countries with higher carbon footprints are shown in darker colors.
                            You can hover over each country to see specific values. The carbon footprint is measured in tons per capita,
                            giving a clear picture of which nations contribute most to global emissions on a per-person basis.
                        </p>   
                  </div>
                  
                    <div class="right-side-div">
                        <div class="right-side-header">
                            <span style="margin-left:5px;">
                                Europe as a Whole
                            </span>
                      </div>
                        <p class="right-text">
                            Europe as a unified region represents a significant portion of global carbon emissions. 
                            When highlighted, you can see the collective impact European countries have on the global 
                            carbon footprint landscape. Despite having individual differences between countries, 
                            Europe's combined carbon footprint demonstrates the importance of regional cooperation 
                            in addressing climate challenges.
                        </p>
                      </div>
                      
                    <div class="right-side-div">
                        <div class="right-side-header">
                            <span style="margin-left:5px;">
                                Carbon Footprint vs GDP
                            </span>
                      </div>
                        <p class="right-text">
                            The scatterplot reveals the relationship between economic development (measured by GDP per capita) 
                            and environmental impact (carbon footprint). Each point represents a country, positioned according 
                            to its GDP and carbon emissions. This visualization helps identify whether countries have managed 
                            to decouple economic growth from carbon emissions - an essential factor in sustainable development.
                            Generally, higher GDP correlates with higher carbon footprints, but some countries break this pattern.
                        </p>
                  </div>
                  
                    <div class="right-side-div">
                        <div class="right-side-header">
                            <span style="margin-left:5px;">
                                European Countries Highlighted
                            </span>
                  </div>
                        <p class="right-text">
                            When European countries are highlighted in the scatterplot, we can compare how they perform 
                            relative to the rest of the world. Many European nations have implemented climate policies 
                            that position them differently on the GDP-emission curve. This final view allows for comparison 
                            between European nations and the rest of the world, showing which countries have been more 
                            successful at balancing economic growth with environmental responsibility.
                        </p>
  </div>
</section>
            </section>
        </div>
    </article>
    
    <!-- 步骤指示器 -->
    <div class="step-indicator">
        <div class="step active" data-step="1"></div>
        <div class="step" data-step="2"></div>
        <div class="step" data-step="3"></div>
        <div class="step" data-step="4"></div>
    </div>
    
    <!-- 自定义的tooltip容器 -->
    <div id="custom-tooltip" class="custom-tooltip"></div>
    
    <!-- 使用globalCarbon.js，但无调试信息 -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // 创建自定义的tooltip处理函数
        window.customTooltip = {
            show: function(event, d) {
                const tooltip = d3.select('#custom-tooltip');
                
                // 准备显示内容
                let content = '<h4>' + (d.properties.name || 'Unknown Country') + '</h4>';
                
                if (d.properties.carbonFootprint) {
                    content += '<p>Carbon Footprint: <span class="data-value">' + 
                               d.properties.carbonFootprint.toFixed(2) + ' t/capita</span></p>';
                } else {
                    content += '<p>Carbon Footprint: <span class="data-value">No data</span></p>';
                }
                
                if (d.properties.gdp) {
                    content += '<p>GDP per capita (log): <span class="data-value">' + 
                               d.properties.gdp.toFixed(2) + '</span></p>';
                }
                
                if (d.properties.isEuropean) {
                    content += '<p>Region: <span class="data-value">Europe</span></p>';
                }
                
                // 设置内容并显示
                tooltip.html(content)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px')
                    .transition()
                    .duration(200)
                    .style('opacity', 1);
            },
            
            move: function(event) {
                d3.select('#custom-tooltip')
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px');
            },
            
            hide: function() {
                d3.select('#custom-tooltip')
                    .transition()
                    .duration(500)
                    .style('opacity', 0);
            }
        };
        
        // 将自定义tooltip添加到window对象，使globalCarbon.js可以访问
        window.myCustomTooltip = window.customTooltip;
        
        // 修改GlobalViz原型中的方法（在原始脚本加载后）
        function patchGlobalViz() {
            if (typeof GlobalViz === 'function') {
                // 修改margin设置，增加左侧和右侧的空间
                const originalInitSvg = GlobalViz.prototype.initSvg;
                GlobalViz.prototype.initSvg = function() {
                    const result = originalInitSvg.apply(this, arguments);
                    // 修改margin使横轴有更多空间
                    this.margin = { left: 120, right: 60, top: 40, bottom: 60 };
                    this.innerW = this.width - this.margin.left - this.margin.right;
                    this.innerH = this.height - this.margin.top - this.margin.bottom;
                    
                    // 重新定位chart区域
                    this.chartArea.attr("transform", `translate(${this.margin.left}, ${this.margin.top})`);
                    
                    return result;
                };
                
                // 修改坐标轴创建函数，确保网格线在数据点下方
                const originalAddAxes = GlobalViz.prototype._addAxes;
                GlobalViz.prototype._addAxes = function() {
                    // 清除已有的坐标轴
                    this.axisG.selectAll("*").remove();
                    
                    // 先添加网格线 - 确保它们在数据点下方
                    // 水平网格线
                    this.axisG.append("g")
                        .attr("class", "grid-lines-horizontal")
                        .selectAll("line")
                        .data(this.yScale.ticks(8))
                        .enter()
                        .append("line")
                        .attr("class", "grid-line")
                        .attr("x1", 0)
                        .attr("x2", this.innerW)
                        .attr("y1", d => this.yScale(d))
                        .attr("y2", d => this.yScale(d))
                        .style("stroke", "#eee")
                        .style("stroke-width", 1);
                    
                    // 垂直网格线
                    this.axisG.append("g")
                        .attr("class", "grid-lines-vertical")
                        .selectAll("line")
                        .data(this.xScale.ticks(8))
                        .enter()
                        .append("line")
                        .attr("class", "grid-line")
                        .attr("x1", d => this.xScale(d))
                        .attr("x2", d => this.xScale(d))
                        .attr("y1", 0)
                        .attr("y2", this.innerH)
                        .style("stroke", "#eee")
                        .style("stroke-width", 1);
                    
                    // X轴 - 修改为更清晰的标签，不显示网格线
                    this.xAxis = this.axisG.append("g")
                      .attr("class", "x-axis")
                      .attr("transform", `translate(0, ${this.innerH})`)
                      .call(d3.axisBottom(this.xScale)
                        .ticks(6)
                        .tickSize(5)  // 只显示短刻度线，不显示网格线
                        .tickPadding(10)
                        .tickFormat(d3.format(".1f")));
                    
                    // Y轴，不显示网格线
                    this.yAxis = this.axisG.append("g")
                      .attr("class", "y-axis")
                      .call(d3.axisLeft(this.yScale)
                        .ticks(8)
                        .tickSize(5)  // 只显示短刻度线，不显示网格线
                        .tickPadding(10)
                        .tickFormat(d3.format(".1f")));
                    
                    // 美化坐标轴
                    this.svg.selectAll(".domain").style("stroke", "#333");
                    this.svg.selectAll(".axis text").style("fill", "#333").style("font-size", "12px");
                    
                    // X轴标签 - 提高可见性
                    this.axisG.append("text")
                      .attr("class", "x-label")
                      .attr("x", this.innerW / 2)
                      .attr("y", this.innerH + 45)
                      .attr("text-anchor", "middle")
                      .attr("font-size", "14px")
                      .attr("font-weight", "bold")
                      .attr("fill", "#333")
                      .text("GDP per capita (log scale)");
                    
                    // Y轴标签 - 提高可见性
                    this.axisG.append("text")
                      .attr("class", "y-label")
                      .attr("transform", "rotate(-90)")
                      .attr("x", -this.innerH / 2)
                      .attr("y", -80)
                      .attr("text-anchor", "middle")
                      .attr("font-size", "14px")
                      .attr("font-weight", "bold")
                      .attr("fill", "#333")
                      .text("Carbon Footprint (t/capita)");
                };
                
                // 修改_executeTransitionToScatterplot方法，确保数据点在网格线上方
                const originalTransitionToScatterplot = GlobalViz.prototype._executeTransitionToScatterplot;
                GlobalViz.prototype._executeTransitionToScatterplot = function() {
                    // 先进行坐标轴设置，包括网格线
                    this._addAxes();
                    
                    // 调用原始转换方法
                    const result = originalTransitionToScatterplot.apply(this, arguments);
                    
                    // 确保散点图中的数据点在最顶层
                    this.mapG.selectAll(".datapoint")
                        .raise();  // 将元素提升到其父元素的子元素列表的顶部
                        
                    return result;
                };
                
                // 改进highlightEuropeanCountries方法，确保高亮显示的数据点在最顶层
                const originalHighlightEuropean = GlobalViz.prototype.highlightEuropeanCountries;
                if (originalHighlightEuropean) {
                    GlobalViz.prototype.highlightEuropeanCountries = function() {
                        const result = originalHighlightEuropean.apply(this, arguments);
                        
                        // 将欧洲国家的数据点提升到顶层
                        this.mapG.selectAll(".datapoint.europe")
                            .raise();
                            
                        return result;
                    };
                }
                
                // 改进drawWorldMap方法，添加自定义tooltip和点击处理
                const originalDrawWorldMap = GlobalViz.prototype.drawWorldMap;
                
                GlobalViz.prototype.drawWorldMap = function() {
                    const result = originalDrawWorldMap.apply(this, arguments);
                    
                    // 向所有国家添加事件处理
                    this.mapG.selectAll(".country")
                        .on("mouseover", function(event, d) {
                            // 调用原有tooltip处理 + 自定义tooltip
                            window.myCustomTooltip.show(event, d);
                            
                            d3.select(this)
                                .attr("stroke", "black")
                                .attr("stroke-width", 2);
                        })
                        .on("mousemove", function(event) {
                            window.myCustomTooltip.move(event);
                        })
                        .on("mouseout", function() {
                            window.myCustomTooltip.hide();
                            
                            d3.select(this)
                                .attr("stroke", "white")
                                .attr("stroke-width", 0.5);
                        })
                        .on("click", function(event, d) {
                            // 点击时也显示tooltip，但持续时间更长
                            window.myCustomTooltip.show(event, d);
                            
                            // 高亮当前国家
                            d3.select(this)
                                .attr("stroke", "black")
                                .attr("stroke-width", 2);
                        });
                    
                    return result;
                };
            }
        }
        
        // 加载globalCarbon.js文件
        const script = document.createElement('script');
        script.src = './js/globalCarbon.js';
        script.onload = function() {
            // 修改GlobalViz原型中的方法
            patchGlobalViz();
            
            // 创建GlobalViz实例
            const viz = new GlobalViz('map');
            // 加载数据并初始化可视化
            viz.loadData();
        };
        document.body.appendChild(script);
    });
    </script>

    <script src="./js/interactive_map.js"  type="module"></script>

</body>

</html>